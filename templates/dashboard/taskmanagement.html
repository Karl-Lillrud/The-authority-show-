{% extends "dashboard/components/base.html" %}
{% block title %}Podcast Task Management{% endblock %}

{% block content %}
<!-- Guest Selection Popup -->
<div id="guest-popup" class="popup">
  <div class="popup-content">
    <header>
      <h1>Select a Guest's Task</h1>
    </header>
    <div class="container guest-selection">
      <div class="card" onclick="selectGuest('Guest A')">
        <img src="{{ url_for('static', filename='images/person1.jpg') }}" alt="Guest A">
        <p class="episode-count orange">3 Open Tasks</p>
      </div>
      <div class="card" onclick="selectGuest('Guest B')">
        <img src="{{ url_for('static', filename='images/person2.jpg') }}" alt="Guest B">
        <p class="episode-count red">8 Open Tasks</p>
      </div>
      <div class="card" onclick="selectGuest('Guest C')">
        <img src="{{ url_for('static', filename='images/person3.jpg') }}" alt="Guest C">
        <p class="episode-count green">0 Open Tasks</p>
      </div>
    </div>
  </div>
</div>

<link rel="stylesheet" href="{{ url_for('static', filename='css/task.css') }}">

<!-- Task Management Section (Initially Hidden) -->
<div id="task-management" style="display:none;">
  <!-- Back Arrow -->
  <a href="{{ url_for('dashboard') }}" class="back-arrow">&#8592; Back</a>
  
  <!-- Page Header -->
  <div class="task-header">
    <h2>Task Management for <span id="selected-guest"></span></h2>
    <div>
      <button id="load-default-btn">Load Default Tasks</button>
      <button id="add-task-btn">+ Add New Task</button>
    </div>
  </div>
  
  <!-- Ordered Task List -->
  <ol id="task-list" class="sortable">
    <!-- Dynamically injected tasks will appear here -->
  </ol>
  
  <!-- Task Modal -->
  <div id="task-modal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal()">&times;</span>
      <h2 id="modal-title">Create New Task</h2>
      
      <label for="task-name">Task Name:</label>
      <input type="text" id="task-name" placeholder="Enter task name">
      
      <label for="task-dependencies">Dependent on Other Task(s):</label>
      <select id="task-dependencies" multiple>
        <!-- Options dynamically populated -->
      </select>
      
      <label for="task-type">Task Type & Action:</label>
      <select id="task-type">
        <option value="manual">Manual</option>
        <option value="email">Automated - Email</option>
        <option value="system">Automated - System Action</option>
        <option value="ai">Automated - AI Script</option>
      </select>
      
      <div id="action-details" class="hidden">
        <label for="action-details-input">Action Details:</label>
        <input type="text" id="action-details-input" placeholder="Enter details">
      </div>
      
      <label for="due-time">Due Time Since Recording Date:</label>
      <input type="text" id="action-link" placeholder="Enter days">
      
      <label for="task-description">Task Description:</label>
      <textarea id="task-description" placeholder="Enter task details"></textarea>
      
      <label for="action-link">Action Link:</label>
      <input type="text" id="action-link" placeholder="Enter external link">
      <input type="text" id="action-link-desc" placeholder="Describe the link">
      
      <label>
        <input type="checkbox" id="submission-required"> Require Information Submission
      </label>
      
      <div class="modal-buttons">
        <button id="save-task-btn">Save Task</button>
        <button class="cancel-btn" onclick="closeModal()">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- Include SortableJS Library for Drag & Drop -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
  // When a guest is selected, update the header and show the task management section.
  function selectGuest(guestName) {
    document.getElementById('selected-guest').textContent = guestName;
    document.getElementById('guest-popup').style.display = 'none';
    document.getElementById('task-management').style.display = 'block';
  }

  // Event listeners for task management buttons.
  document.getElementById("add-task-btn").addEventListener("click", openModal);
  document.getElementById("load-default-btn").addEventListener("click", loadDefaultTasks);

  function openModal() {
    document.getElementById("task-modal").style.display = "flex";
    document.getElementById("modal-title").innerText = "Create New Task";
    document.getElementById("save-task-btn").setAttribute("onclick", "saveTask()");
  }

  function closeModal() {
    document.getElementById("task-modal").style.display = "none";
  }

  function saveTask() {
    let taskName = document.getElementById("task-name").value.trim();
    if (taskName.length < 2) {
      alert("Task name must be at least 2 characters.");
      return;
    }
    let li = document.createElement("li");
    li.innerHTML = `
      <div class="task-details">
        <span class="task-name">${taskName}</span>
      </div>
      <div class="task-actions">
        <button class="edit-btn" onclick="editTask(this)">Edit</button>
        <button class="delete-btn" onclick="deleteTask(this)">Delete</button>
      </div>
    `;
    document.getElementById("task-list").appendChild(li);
    closeModal();
  }

  function editTask(button) {
    let li = button.closest("li");
    let taskName = li.querySelector(".task-name").textContent;
    document.getElementById("task-name").value = taskName;
    document.getElementById("modal-title").innerText = "Edit Task";
    document.getElementById("task-modal").style.display = "flex";
    document.getElementById("save-task-btn").setAttribute("onclick", `updateTask('${taskName}', this)`);
  }

  function updateTask(oldTaskName, button) {
    let newTaskName = document.getElementById("task-name").value.trim();
    if (newTaskName.length < 2) {
      alert("Task name must be at least 2 characters.");
      return;
    }
    let tasks = document.querySelectorAll(".task-name");
    tasks.forEach(task => {
      if (task.textContent === oldTaskName) {
        task.textContent = newTaskName;
      }
    });
    closeModal();
  }

  function deleteTask(button) {
    button.closest("li").remove();
  }

  function loadDefaultTasks() {
    const defaultTasks = [
      "Guest received pitch email to join the show as a guest",
      "Guest filled out the guest form and picked a date",
      "Create episode in the system with all predefined tickets",
      "Scheduling confirmation email sent",
      "Guest preparation email sent",
      "Email sent to guest with cover art and suggestion to post in social media",
      "Create cover art",
      "Recording Scheduled",
      "Recording in Riverside",
      "Check the transcript and make corrections",
      "Extract the transcript from Riverside and Save to the episode database",
      "Suggest exact parts to remove which would improve the episode",
      "Cut and edit the recording by removing parts in the script",
      "Extract the final transcript from Riverside and Save to the episode database",
      "Implement the background sound suggestions where they add value",
      "Improve audio (Final step for Riverside episode to be completed)",
      "Release date decided",
      "Generate shorts with OPUS",
      "Shorts saved to cloud drive",
      "Generate quotes",
      "Send Email with link to download shorts and quote images to the guest",
      "Guest follow-up ask for recommendations of other guests",
      "Upload and Schedule podcast release",
      "Schedule Social Media Posts (Metricool)",
      "Generate FAQ",
      "Review and approve as OK to publish",
      "Review and combine with the FAQ and publish on LinkedIn",
      "Review and publish on website",
      "Episode goes live soon or Now live announcement",
      "Mark episode as completed"
    ];
    const taskList = document.getElementById("task-list");
    defaultTasks.forEach(task => {
      let li = document.createElement("li");
      li.innerHTML = `
        <div class="task-details">
          <span class="task-name">${task}</span>
        </div>
        <div class="task-actions">
          <button class="edit-btn" onclick="editTask(this)">Edit</button>
          <button class="delete-btn" onclick="deleteTask(this)">Delete</button>
        </div>
      `;
      taskList.appendChild(li);
    });
  }

  new Sortable(document.getElementById('task-list'), {
    animation: 150,
    ghostClass: 'drag-ghost'
  });
</script>
{% endblock %}
