<!-- Include SortableJS Library for Drag & Drop -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
  // When a guest is selected, update the header and show the task management section.
  async function selectGuest(guestId, guestName) {
    document.getElementById("selected-guest").textContent = guestName;
    document.getElementById("guest-popup").style.display = "none";
    document.getElementById("task-management").style.display = "block";
    await fetchEpisodes(guestId);
    await fetchTasks();
  }

  async function fetchEpisodes(guestId) {
    try {
      const response = await fetch(
        `/episodes/get_episodes_by_guest/${guestId}`
      );
      const data = await response.json();

      if (response.ok) {
        const viewEpisodeDropdown = document.getElementById("episode-dropdown");
        const addTasksEpisodeDropdown = document.getElementById(
          "add-tasks-episode-dropdown"
        );
        viewEpisodeDropdown.innerHTML = ""; // Clear existing episodes
        addTasksEpisodeDropdown.innerHTML = ""; // Clear existing episodes

        data.episodes.forEach((episode) => {
          let a = document.createElement("a");
          a.textContent = episode.title;
          a.href = "#";
          a.onclick = () => selectEpisode(episode.episode_id);
          viewEpisodeDropdown.appendChild(a);

          let b = document.createElement("a");
          b.textContent = episode.title;
          b.href = "#";
          b.onclick = () => selectEpisode(episode.episode_id);
          addTasksEpisodeDropdown.appendChild(b);
        });

        console.log("Episodes fetched and added to dropdowns:", data.episodes);
      } else {
        console.error("Failed to fetch episodes:", data.error);
        alert("Failed to fetch episodes: " + data.error);
      }
    } catch (error) {
      console.error("Error fetching episodes:", error);
      alert("Failed to fetch episodes.");
    }
  }

  function selectEpisode(episodeId) {
    console.log("Selected episode ID:", episodeId);
    // Implement logic to handle episode selection
  }

  // Ensure "Add Task" button exists before adding event listener
  if (document.getElementById("add-task-btn")) {
    document
      .getElementById("add-task-btn")
      .addEventListener("click", openModal);
  }

  function openModal() {
    document.getElementById("task-modal").style.display = "flex";
    document.getElementById("modal-title").innerText = "Create New Task";
    // Set default action for save button to create new task
    document
      .getElementById("save-task-btn")
      .setAttribute("onclick", "saveTask()");
  }

  function closeModal() {
    document.getElementById("task-modal").style.display = "none";
  }

  async function saveTask() {
    let taskName = document.getElementById("task-name").value.trim();
    let taskDependencies = Array.from(
      document.getElementById("task-dependencies").selectedOptions
    ).map((option) => option.value);
    let taskType = document.getElementById("task-type").value;
    let dueTime = document.getElementById("due-time").value.trim();
    let taskDescription = document
      .getElementById("task-description")
      .value.trim();
    let actionLink = document.getElementById("action-link").value.trim();
    let actionLinkDesc = document
      .getElementById("action-link-desc")
      .value.trim();
    let submissionRequired = document.getElementById(
      "submission-required"
    ).checked;

    // Dummy Podcast ID (Replace dynamically)
    const podcastId = "YOUR_PODCAST_ID";

    if (!taskName || !podcastId) {
      alert("Task name and PodcastId are required!");
      return;
    }

    const taskData = {
      PodcastId: podcastId,
      taskname: taskName,
      Description: taskDescription,
      taskDependencies: taskDependencies,
      taskType: taskType,
      Daycount: parseInt(dueTime) || 0,
      action: [{ actionurl: actionLink, externalurl: actionLinkDesc }],
      submission: submissionRequired ? "Required" : "Optional"
    };

    try {
      const response = await fetch("/register_podtask", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(taskData)
      });

      const result = await response.json();
      if (response.ok) {
        alert("Task added successfully!");
        closeModal();
        fetchTasks(); // Refresh the task list
      } else {
        console.error("Error adding task:", result.error);
        alert("Error: " + result.error);
      }
    } catch (error) {
      console.error("Error:", error);
      alert("Failed to add task.");
    }
  }

  // Fetch task data and open edit modal with pre-filled fields
  async function editTask(taskId) {
    try {
      const response = await fetch(`/get_podtask/${taskId}`);
      if (!response.ok) {
        console.error("Failed to fetch task data");
        alert("Failed to fetch task data");
        return;
      }
      const task = await response.json();

      // Pre-fill the modal fields with fetched task data
      document.getElementById("task-name").value =
        task.taskname || task.task_name;
      document.getElementById("task-description").value =
        task.Description || "";
      document.getElementById("due-time").value = task.DayCount || "";
      document.getElementById("action-link").value = task.ActionUrl || "";
      document.getElementById("action-link-desc").value =
        task.UrlDescribe || "";
      document.getElementById("submission-required").checked =
        task.SubimissionReq || false;

      // Set modal title and update button action
      document.getElementById("modal-title").innerText = "Edit Task";
      document.getElementById("task-modal").style.display = "flex";
      document
        .getElementById("save-task-btn")
        .setAttribute("onclick", `updateTask('${task._id}')`);
    } catch (error) {
      console.error("Error fetching task details:", error);
      alert("Error fetching task details");
    }
  }

  // Update task data after editing
  async function updateTask(taskId) {
    const taskName = document.getElementById("task-name").value.trim();
    const taskDescription = document
      .getElementById("task-description")
      .value.trim();
    const dueTime = document.getElementById("due-time").value.trim();
    const actionLink = document.getElementById("action-link").value.trim();
    const actionLinkDesc = document
      .getElementById("action-link-desc")
      .value.trim();
    const submissionRequired = document.getElementById(
      "submission-required"
    ).checked;

    const updatedTask = {
      taskname: taskName,
      Description: taskDescription,
      DayCount: parseInt(dueTime) || 0,
      actionurl: actionLink,
      externalurl: actionLinkDesc,
      submission: submissionRequired ? "Required" : "Optional"
    };

    try {
      const response = await fetch(`/update_podtask/${taskId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(updatedTask)
      });
      const result = await response.json();
      if (response.ok) {
        alert("Task updated successfully!");
        closeModal();
        fetchTasks(); // Refresh the task list to reflect changes
      } else {
        console.error("Error updating task:", result.error);
        alert("Error: " + result.error);
      }
    } catch (error) {
      console.error("Error updating task:", error);
      alert("Error updating task: " + error.message);
    }
  }

  async function deleteTask(taskId) {
    try {
      const response = await fetch(`/delete_podtask/${taskId}`, {
        method: "DELETE"
      });

      const result = await response.json();
      if (response.ok) {
        alert("Task deleted successfully!");
        fetchTasks(); // Refresh tasks
      } else {
        console.error("Error deleting task:", result.error);
        alert("Error deleting task: " + result.error);
      }
    } catch (error) {
      console.error("Error deleting task:", error);
      alert("Failed to delete task.");
    }
  }

  async function deleteDefaultTask(taskId) {
    try {
      const response = await fetch(`/delete_default_task/${taskId}`, {
        method: "DELETE"
      });

      const result = await response.json();
      if (response.ok) {
        alert("Default task deleted successfully!");
        fetchDefaultTasks(); // Refresh default tasks
      } else {
        console.error("Error deleting default task:", result.error);
        alert("Error deleting default task: " + result.error);
      }
    } catch (error) {
      console.error("Error deleting default task:", error);
      alert("Failed to delete default task.");
    }
  }

  async function fetchTasks() {
    try {
      const response = await fetch("/get_podtasks");
      const data = await response.json();

      if (response.ok) {
        const taskList = document.getElementById("task-list");
        taskList.innerHTML = ""; // Clear existing tasks

        data.podtasks.forEach((task) => {
          let li = document.createElement("li");
          li.innerHTML = `
            <div class="task-details">
                <span class="task-name">${task.taskname}</span>
            </div>
            <div class="task-actions">
                <button class="edit-btn" onclick="editTask('${task._id}')">Edit</button>
                <button class="delete-btn" onclick="deleteTask('${task._id}')">Delete</button>
            </div>
        `;
          taskList.appendChild(li);
        });
      } else {
        console.error("Failed to fetch tasks:", data.error);
        alert("Failed to fetch tasks: " + data.error);
      }
    } catch (error) {
      console.error("Error fetching tasks:", error);
      alert("Failed to fetch tasks.");
    }
  }

  async function fetchDefaultTasks() {
    try {
      const response = await fetch("/get_default_tasks");
      const data = await response.json();

      if (response.ok) {
        const defaultTasksList = document.getElementById("default-tasks-list");
        defaultTasksList.innerHTML = ""; // Clear existing tasks

        data.default_tasks.forEach((task) => {
          let div = document.createElement("div");
          div.className = "default-task-item";
          div.innerHTML = `
            <span class="task-name">${task.task_name}</span>
            <input type="checkbox" class="default-task-checkbox" value="${task.task_name}">
        `;
          defaultTasksList.appendChild(div);

          console.log(
            "Default tasks fetched and added to list:",
            data.default_tasks
          );
        });
      } else {
        console.error("Failed to fetch default tasks:", data.error);
        alert("Failed to fetch default tasks: " + data.error);
      }
    } catch (error) {
      console.error("Error fetching default tasks:", error);
      alert("Failed to fetch default tasks.");
    }
  }

  // Fetch tasks on page load
  document.addEventListener("DOMContentLoaded", fetchTasks);

  // Open Default Tasks Popup
  function openDefaultTasksPopup() {
    document.getElementById("default-tasks-popup").style.display = "flex";
    fetchDefaultTasks();
  }

  // Close Default Tasks Popup
  function closeDefaultTasksPopup() {
    document.getElementById("default-tasks-popup").style.display = "none";
  }

  // Add Selected Default Tasks
  async function addSelectedDefaultTasks() {
    const checkboxes = document.querySelectorAll(
      ".default-task-checkbox:checked"
    );
    const selectedTasks = Array.from(checkboxes).map((checkbox) => ({
      taskname: checkbox.value,
      Description: "", // Can be filled later
      Daycount: 0, // Default
      action: [],
      submission: "Optional"
    }));

    try {
      for (const task of selectedTasks) {
        await fetch("/register_podtask", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(task)
        });
      }
      alert("Selected tasks added successfully!");
      fetchTasks(); // Refresh tasks
    } catch (error) {
      console.error("Error adding tasks:", error);
      alert("Failed to add tasks.");
    }

    closeDefaultTasksPopup();
  }

  // Enable Drag & Drop Sorting
  new Sortable(document.getElementById("task-list"), {
    animation: 150,
    ghostClass: "drag-ghost"
  });

  async function fetchOpenEpisodes() {
    try {
      const response = await fetch("/episodes/get_open_episodes");
      const data = await response.json();

      if (response.ok) {
        document.getElementById(
          "ollina-episodes"
        ).textContent = `${data.GUEST_ID_1} Episodes`;
        document.getElementById(
          "olle-episodes"
        ).textContent = `${data.GUEST_ID_2} Episodes`;
        document.getElementById(
          "olga-episodes"
        ).textContent = `${data.GUEST_ID_3} Episodes`;
      } else {
        console.error("Failed to fetch episodes:", data.error);
        alert("Failed to fetch episodes: " + data.error);
      }
    } catch (error) {
      console.error("Error fetching episodes:", error);
      alert("Failed to fetch episodes.");
    }
  }

  // Fetch open episodes on page load
  document.addEventListener("DOMContentLoaded", fetchOpenEpisodes);
</script>
