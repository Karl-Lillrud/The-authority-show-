{% extends "dashboard/components/base.html" %}

{% block title %}Team Leaderboard Dashboard{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">

<script>
// Globala funktioner som nu √§r tillg√§ngliga √∂verallt
function updateCredits() {
    console.log("üîÑ Fetching updated credits...");
    const userEmail = "{{ user_email }}";
    fetch(`/credits?email=${encodeURIComponent(userEmail)}`)
      .then(response => response.json())
      .then(data => {
          if (data.credits !== undefined) {
              console.log("‚úÖ Updated credits:", data.credits);
              // Se till att .credits-badge finns i DOM
              const badge = document.querySelector(".credits-badge span");
              if (badge) {
                  badge.textContent = `${data.credits} Credits`;
              }
          } else {
              console.error("‚ùå Failed to fetch credits!");
          }
      })
      .catch(error => console.error("‚ùå Error fetching credits:", error));
}

function updateClaimButton(unclaimedCredits) {
    console.log("üîç Checking Claim Button Visibility...");
    console.log("üìä Unclaimed Credits Received:", unclaimedCredits);
    const claimButton = document.getElementById("claimCreditsButton");
    const unclaimedDisplay = document.getElementById("unclaimedCreditsDisplay");
    if (!claimButton || !unclaimedDisplay) {
        console.error("‚ùå ERROR: Claim button or display not found in DOM!");
        return;
    }
    if (unclaimedCredits > 0) {
        console.log("‚úÖ Showing Claim Button!");
        claimButton.style.display = "block";
        claimButton.textContent = `üéÅ Claim Your ${unclaimedCredits} Credits`;
        unclaimedDisplay.textContent = `${unclaimedCredits} Unclaimed Credits`;
        unclaimedDisplay.style.display = "block";
    } else {
        console.log("‚ùå Hiding Claim Button - No unclaimed credits.");
        claimButton.style.display = "none";
        unclaimedDisplay.style.display = "none";
        unclaimedDisplay.textContent = "";
    }
}

document.addEventListener("DOMContentLoaded", function() {
  // Homepage popup remains unchanged
  if (!sessionStorage.getItem("homepageViewed")) {
    document.getElementById("homepage-popup").style.display = "flex";
    sessionStorage.setItem("homepageViewed", "true");
  }

  const taskPopup = document.getElementById("task-popup");
  const closeTaskPopup = document.getElementById("close-popup");
  // Hide popup initially
  taskPopup.style.display = "none";

  // Use event delegation to show popup only when a .task-text is clicked
  document.addEventListener("click", function(e) {
    if (e.target.closest('.task-text')) {
      e.stopPropagation();
      taskPopup.style.display = "flex";
    }
  });

  // Close popup on clicking the close button
  closeTaskPopup.addEventListener("click", function(e) {
    taskPopup.style.display = "none";
  });

  // Optional: close popup if clicking outside the popup-content
  taskPopup.addEventListener("click", function(e) {
    if (e.target === taskPopup) {
      taskPopup.style.display = "none";
    }
  });
});

document.addEventListener("DOMContentLoaded", function() {
  // Attach change event listener to all checkboxes
  document.querySelectorAll('.task-check').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      const listItem = this.closest('li');
      if (this.checked) {
        listItem.classList.add('completed');
        // Delay sorting to allow the animation to play
        setTimeout(() => {
          sortTasks(listItem.parentElement);
        }, 500);
      } else {
        listItem.classList.remove('completed');
      }
    });
  });

  function sortTasks(taskList) {
    const tasks = Array.from(taskList.children);
    tasks.sort((a, b) => {
      return a.querySelector('.task-check').checked - b.querySelector('.task-check').checked;
    });
    tasks.forEach(task => taskList.appendChild(task));
  }
});

// Homepage Popup
</script>

<div id="homepage-popup" class="popup">
    <div class="popup-content">
        <iframe id="homepage-iframe" src="{{ url_for('dashboard_bp.homepage') }}" width="100%" height="800px" style="border: none;"></iframe>
    </div>
</div>

<div class="container">
    <main class="main-content">
        <section class="leaderboard-section">
            <h2>Team Leaderboard</h2>
            <div class="team-leaderboard">
                <table class="leaderboard-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Tasks Completed</th>
                            <th>Total Points</th>
                            <th>Months Won</th>
                            <th>Shadow Goal</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Marcus</td>
                            <td>-1</td>
                            <td>2,342,255</td>
                            <td>11</td>
                            <td>3,000,000</td>
                        </tr>
                        <tr>
                            <td>Tommy</td>
                            <td>9,222</td>
                            <td>1,239,993</td>
                            <td>4</td>
                            <td>1,500,000</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section class="task-cards">
            <div class="cards-container">
                <!-- Din √∂vriga kortkod h√§r -->
            </div>
        </section>

        <!-- Place this outside the card markup -->
        <div id="task-popup" class="popup" style="display: none;">
            <div class="popup-content">
              <span id="close-popup" class="close-btn"></span>
              <h2>Social Schedule</h2>
              <div id="popup-task-content">
                SM SCHEDULE.
                <input type="checkbox" class="task-checkbox">
              </div>
              <p class="popup-instructions">INSTRUCTIONS:</p>
              <p class="popup-instructions">SCHEDULE THE PREPARED SOCIAL MEDIA MATERIAL</p>
              <div class="popup-actions">
                <p>GO TO THE SOCIAL MEDIA SCHEDULE <button class="popup-button">OPEN</button></p>
                <p>OPEN THE EPISODE CONTENT FOLDER <button class="popup-button">OPEN</button></p>
              </div>
            </div>
        </div>

        <!-- REFERAL SECTION -->
        <section class="referral-section">
          <h3>Refer a Friend & Earn 200 Credits!</h3>
          <p>Share your referral link and earn extra credits when a friend signs up.</p>

          <!-- Referral link -->
          <input type="text" id="referralLink" value="http://127.0.0.1:8000/register?referral={{ referral_code }}" readonly>
          
          <button onclick="copyReferral()">Copy Link</button>

          <!-- Invite Friends Form -->
          <h4>Invite Friends via Email üì©</h4>
          <form id="inviteForm">
              <input type="email" id="friendEmail" placeholder="Enter friend's email" required>
              <button type="submit">Send Invite</button>
          </form>

          <!-- Referral Progress Tracker -->
          <div class="referral-progress">
            <h4>ü§ù Referral Bonuses</h4>
            <p id="referralMilestone">You have referred 0/3 friends for 1,500 bonus credits!</p>
            <progress id="referralProgress" value="0" max="3"></progress>
            <p id="referralCount"></p>
          </div>

          <p id="inviteMessage" style="display: none;"></p>
        </section>

        <!-- Referral Popup Reminder -->
        <div id="referral-popup" class="popup" style="display: none;">
          <div class="popup-content">
              <h3>‚ö†Ô∏è Low Credits! Invite Friends & Earn More! üéÅ</h3>
              <p>You have less than 500 credits left. Invite friends to earn extra!</p>
              <button onclick="openInviteForm()">Invite Now</button>
              <button onclick="closeReferralPopup()">Close</button>
          </div>
        </div>

        <script>
            function copyReferral() {
              const referralInput = document.getElementById("referralLink");
              referralInput.select();
              document.execCommand("copy");
              alert("Referral link copied!");
            }

          document.getElementById("inviteForm").addEventListener("submit", async function(event) {
              event.preventDefault();
              const emailInput = document.getElementById("friendEmail");
              const email = emailInput.value;
              const referralCode = "{{ referral_code }}";
              const inviteMessage = document.getElementById("inviteMessage");

              try {
                  const response = await fetch("/send-invite", {
                      method: "POST",
                      headers: { "Content-Type": "application/json" },
                      body: JSON.stringify({ email, referralCode })
                  });

                  const result = await response.json();

                  if (response.ok) {
                      inviteMessage.textContent = "‚úÖ Invite sent successfully!";
                      inviteMessage.style.color = "green";
                      inviteMessage.style.display = "block";
                      emailInput.value = "";
                      setTimeout(() => {
                          inviteMessage.style.display = "none";
                      }, 3000);
                  } else {
                      inviteMessage.textContent = "‚ùå Failed to send invite.";
                      inviteMessage.style.color = "red";
                      inviteMessage.style.display = "block";
                  }
              } catch (error) {
                  console.error("Error:", error);
                  inviteMessage.textContent = "‚ùå An error occurred.";
                  inviteMessage.style.color = "red";
                  inviteMessage.style.display = "block";
              }
          });

          // Show referral popup if credits are low
          document.addEventListener("DOMContentLoaded", function() {
              const credits = parseInt("{{ credits }}", 10);
              if (credits < 500) {
                  document.getElementById("referral-popup").style.display = "flex";
              }
          });

          function openInviteForm() {
              document.getElementById("referral-popup").style.display = "none";
              document.getElementById("inviteForm").scrollIntoView({ behavior: "smooth" });
          }

          function closeReferralPopup() {
              document.getElementById("referral-popup").style.display = "none";
          }
        </script>

        <style>
            /* Popup styling */
            .popup {
                position: fixed;
                top: 0; left: 0;
                width: 100%; height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .popup-content {
                background: white;
                padding: 20px;
                border-radius: 10px;
                text-align: center;
            }
        </style>

        <!-- Gamification Widget Section -->
        <style>
          /* Gamification Widget Section */
          .gamification-widget {
              background: #f9f9f9;
              padding: 20px;
              border-radius: 10px;
              box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
              text-align: center;
              margin-top: 20px;
          }
          .gamification-widget h3 {
              font-size: 22px;
              font-weight: bold;
              color: #333;
          }
          .progress-item {
              margin: 15px 0;
          }
          .progress-item p {
              font-size: 16px;
              margin-bottom: 8px;
              color: #555;
          }
          progress {
              width: 100%;
              height: 12px;
              border-radius: 6px;
              overflow: hidden;
              background: #ddd;
          }
          progress::-webkit-progress-bar {
              background: #ddd;
          }
          progress::-webkit-progress-value {
              background: #4CAF50;
              border-radius: 6px;
          }
          progress::-moz-progress-bar {
              background: #4CAF50;
              border-radius: 6px;
          }
          .leaderboard-preview {
              margin-top: 20px;
              padding: 15px;
              background: white;
              border-radius: 10px;
              box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
          }
          .leaderboard-preview h4 {
              font-size: 18px;
              font-weight: bold;
              color: #444;
              margin-bottom: 10px;
          }
          .leaderboard-preview ul {
              list-style: none;
              padding: 0;
          }
          .leaderboard-preview li {
              font-size: 16px;
              margin: 5px 0;
              color: #666;
          }
          .claim-button {
              display: block;
              margin: 20px auto;
              padding: 10px 20px;
              background-color: #4CAF50;
              color: white;
              border: none;
              border-radius: 5px;
              font-size: 16px;
              cursor: pointer;
              transition: background 0.3s;
          }
          .claim-button:hover {
              background-color: #45a049;
          }
          #unclaimedCreditsDisplay {
              margin-top: 10px;
              font-size: 16px;
              color: #333;
              font-weight: bold;
          }
        </style>

        <section class="gamification-widget">
          <h3>üéØ Progress & Rewards</h3>
          <div class="progress-item">
              <p>You're <span id="episodes-left">2</span>/3 episodes away from unlocking 500 credits!</p>
              <progress id="episode-progress" value="2" max="3"></progress>
          </div>
          <div class="progress-item">
              <p>üî• <span id="streak-days">4</span>-Day Streak ‚Äì Keep going for an extra 500 credits!</p>
          </div>
          <div class="leaderboard-preview">
              <h4>üèÜ Top 3 Podcasters This Week</h4>
              <ul id="leaderboard">
                  <li>1. Marcus - 2,342,255 points</li>
                  <li>2. Tommy - 1,239,993 points</li>
                  <li>3. Ollina - 900,000 points</li>
              </ul>
          </div>
          <button id="claimCreditsButton" onclick="claimCredits()" class="claim-button" style="display: none;">
              üéÅ Claim Your Credits
          </button>
          <p id="unclaimedCreditsDisplay"></p>
        </section>

        <div id="credits-info">
            <h2>Your Credits</h2>
            <p>Total Credits: {{ credits.credits }}</p>
            <p>Unclaimed Credits: {{ credits.unclaimed_credits }}</p>
            <p>Referral Bonus: {{ credits.referral_bonus }}</p>
            <p>Referrals: {{ credits.referrals }}</p>
            <p>VIP Status: {{ credits.vip_status }}</p>
            <p>Credits Expire At: {{ credits.credits_expires_at }}</p>
            <p>Episodes Published: {{ credits.episodes_published }}</p>
            <p>Streak Days: {{ credits.streak_days }}</p>
        </div>

        <script>
          function claimCredits() {
            const userEmail = "{{ user_email }}";
            if (!userEmail) {
                alert("‚ùå Error: No email found!");
                return;
            }
            fetch("/claim-reward", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email: userEmail })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("üéâ " + data.message);
                    updateCredits();
                    updateClaimButton(0);
                } else {
                    alert("‚ùå " + data.error);
                }
            })
            .catch(error => console.error("‚ùå Error claiming credits:", error));
          }

          document.addEventListener("DOMContentLoaded", function () {
              const userEmail = "{{ user_email|safe }}";
              if (!userEmail || userEmail.trim() === "") {
                  console.error("‚ö†Ô∏è No user email found in session!");
                  return;
              }
              let lastReferralCount = parseInt(localStorage.getItem("lastReferralCount")) || 0;

              function connectSSE() {
                  console.log("üîÑ Connecting to SSE...");
                  const eventSource = new EventSource(`/stream-referral-updates?email=${encodeURIComponent(userEmail)}`);
                  eventSource.onmessage = function(event) {
                      const data = JSON.parse(event.data);
                      if (data.ping) return;
                      console.log("üîÑ Live update received:", data);
                      updateReferralUI(data.referrals);
                      updateCredits();
                      updateClaimButton(data.referral_bonus);
                      if (data.referrals > lastReferralCount) {
                          lastReferralCount = data.referrals;
                          localStorage.setItem("lastReferralCount", lastReferralCount);
                      }
                  };
                  eventSource.onerror = function(error) {
                      console.error("‚ùå SSE Connection Error. Retrying in 5s...", error);
                      eventSource.close();
                      setTimeout(connectSSE, 5000);
                  };
              }

              async function updateUserProgress() {
                  console.log("üîÑ Fetching updated user progress...");
                  try {
                      const response = await fetch(`/user-progress?email=${encodeURIComponent(userEmail)}`);
                      const data = await response.json();
                      console.log("‚úÖ Updated User Progress:", data);
                      if (!data || Object.keys(data).length === 0) {
                          console.error("‚ùå No user progress data received!");
                          return;
                      }
                      document.getElementById("episodes-left").textContent = 3 - data.episodes_published;
                      document.getElementById("episode-progress").value = data.episodes_published;
                      document.getElementById("streak-days").textContent = data.streak_days;
                      const referralBonus = data.referral_bonus;
                      updateClaimButton(referralBonus);
                      updateReferralUI(data.referrals);
                  } catch (error) {
                      console.error("‚ùå Error fetching user progress:", error);
                  }
              }

              connectSSE();
              updateUserProgress();
              updateCredits();
          });

          // Global updateReferralUI function with safe fallback
          function updateReferralUI(referrals) {
              console.log("üîÑ Updating Referral UI with count:", referrals);
              const referralProgressElement = document.getElementById("referralProgress");
              const referralMilestoneElement = document.getElementById("referralMilestone");
              const referralCount = (typeof referrals === "number" && isFinite(referrals)) ? referrals : 0;
              if (referralProgressElement) {
                  referralProgressElement.value = referralCount;
                  referralProgressElement.max = 10;
              }
              if (referralMilestoneElement) {
                  let nextMilestone = 3;
                  let bonusAmount = 1500;
                  let vipText = "";
                  if (referralCount >= 3 && referralCount < 5) {
                      nextMilestone = 5;
                      bonusAmount = 1000;
                  } else if (referralCount >= 5 && referralCount < 10) {
                      nextMilestone = 10;
                      bonusAmount = 2500;
                      vipText = " + VIP-status üèÖ";
                  } else if (referralCount >= 10) {
                      nextMilestone = 10;
                      bonusAmount = 2500;
                      vipText = " VIP-status üèÖ unlocked!";
                  }
                  referralMilestoneElement.textContent = `üî• Referral Bonuses: ${referralCount}/${nextMilestone} friends for ${bonusAmount} bonus credits${vipText}`;
              }
              console.log("‚úÖ Referral UI Updated!");
          }
        </script>
    </main>
</div>
{% endblock %}
